using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Example.Demo;
using Zonit.Messaging.Commands;
using Zonit.Messaging.Events;
using Zonit.Messaging.Tasks;

namespace Example;

/// <summary>
/// Aplikacja demonstracyjna dla Zonit.Messaging.
/// 
/// Pokazuje trzy g³ówne wzorce:
/// 1. Commands - Request/Response (CQRS)
/// 2. Events - Pub/Sub
/// 3. Tasks - Background Jobs
/// </summary>
internal class Program
{
    static async Task Main(string[] args)
    {
        Console.OutputEncoding = System.Text.Encoding.UTF8;
        
        // Buduj host z zarejestrowanymi serwisami
        var host = Host.CreateDefaultBuilder(args)
            .ConfigureServices((_, services) =>
            {
                // ???????????????????????????????????????????????????????????????
                // COMMANDS (CQRS) - Request/Response
                // ???????????????????????????????????????????????????????????????
                // Source Generator (AOT-safe) - automatycznie wykrywa IRequestHandler<,>
                services.AddCommandHandlers();

                // ???????????????????????????????????????????????????????????????
                // EVENTS (Pub/Sub) - wielokrotni subskrybenci
                // ???????????????????????????????????????????????????????????????
                // Ten projekt u¿ywa starego API (EventBase<T>), wiêc rêczna rejestracja:
                services.AddEventProvider();
                // Dla nowego API (IEventHandler<T>) u¿yj: services.AddEventHandlers();

                // ???????????????????????????????????????????????????????????????
                // TASKS (Background Jobs) - kolejkowane zadania
                // ???????????????????????????????????????????????????????????????
                // Ten projekt nie ma TaskHandler<T>, wiêc rêczna rejestracja:
                services.AddTaskProvider();
                // Dla nowego API (TaskHandler<T>) u¿yj: services.AddTaskHandlers();
            })
            .Build();

        // Uruchom serwisy w tle
        await host.StartAsync();

        // Pobierz serwisy z DI
        var commandProvider = host.Services.GetRequiredService<ICommandProvider>();
        var eventManager = host.Services.GetRequiredService<IEventManager>();
        var eventProvider = host.Services.GetRequiredService<IEventProvider>();
        var taskManager = host.Services.GetRequiredService<ITaskManager>();
        var taskProvider = host.Services.GetRequiredService<ITaskProvider>();

        // Uruchom interaktywne menu
        await RunMenuAsync(commandProvider, eventManager, eventProvider, taskManager, taskProvider);

        // Zatrzymaj host
        await host.StopAsync();
    }

    static async Task RunMenuAsync(
        ICommandProvider commandProvider,
        IEventManager eventManager,
        IEventProvider eventProvider,
        ITaskManager taskManager,
        ITaskProvider taskProvider)
    {
        while (true)
        {
            ClearConsole();
            PrintHeader();
            
            Console.WriteLine("Wybierz modu³ do testowania:");
            Console.WriteLine();
            Console.WriteLine("  1. Commands - Request/Response (CQRS)");
            Console.WriteLine("     Synchroniczna komunikacja, jeden handler, zwraca wynik");
            Console.WriteLine();
            Console.WriteLine("  2. Events - Pub/Sub");
            Console.WriteLine("     Asynchroniczna komunikacja, wielu subskrybentów (fan-out)");
            Console.WriteLine();
            Console.WriteLine("  3. Tasks - Background Jobs");
            Console.WriteLine("     D³ugo trwaj¹ce zadania, retry, kolejkowanie");
            Console.WriteLine();
            Console.WriteLine("  0. Wyjœcie");
            Console.WriteLine();
            Console.Write("Wybór: ");

            var choice = Console.ReadLine();

            switch (choice)
            {
                case "1":
                    await CommandsDemo.RunAsync(commandProvider);
                    break;
                case "2":
                    await EventsDemo.RunAsync(eventManager, eventProvider);
                    break;
                case "3":
                    await TasksDemo.RunAsync(taskManager, taskProvider);
                    break;
                case "0":
                    Console.WriteLine("\nDo widzenia!");
                    return;
                default:
                    Console.WriteLine("Nieprawid³owy wybór. Naciœnij Enter...");
                    Console.ReadLine();
                    break;
            }
        }
    }

    static void PrintHeader()
    {
        Console.WriteLine("????????????????????????????????????????????????????????????????");
        Console.WriteLine("?                                                              ?");
        Console.WriteLine("?              ?? ZONIT.MESSAGING DEMO ??                     ?");
        Console.WriteLine("?                                                              ?");
        Console.WriteLine("?     Biblioteka do komunikacji w architekturze CQRS/DDD      ?");
        Console.WriteLine("?                                                              ?");
        Console.WriteLine("????????????????????????????????????????????????????????????????");
        Console.WriteLine("?  Commands  ?  Request/Response  ?  ICommandProvider         ?");
        Console.WriteLine("?  Events    ?  Pub/Sub           ?  IEventProvider           ?");
        Console.WriteLine("?  Tasks     ?  Background Jobs   ?  ITaskProvider            ?");
        Console.WriteLine("????????????????????????????????????????????????????????????????");
        Console.WriteLine();
    }

    static void ClearConsole()
    {
        try { Console.Clear(); }
        catch (IOException) { Console.WriteLine(new string('\n', 50)); }
    }
}
